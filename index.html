<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация на фестиваль</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .progress {
            background: #e9ecef;
            height: 8px;
            border-radius: 20px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #fafafa;
            margin-bottom: 15px;
        }

        .search-box:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .consultants-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .consultant-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            text-align: center;
        }

        .consultant-card:hover {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .consultant-card.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .consultant-card.hidden {
            display: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #97cbff;
        }

        .participant-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .emoji {
            margin-right: 8px;
        }

        .admin-container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .admin-login-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
        }

        .admin-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .admin-nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .admin-nav-item.active {
            background: white;
            border-bottom-color: #4facfe;
            font-weight: 600;
        }

        .admin-tab-content {
            padding: 20px;
        }

        .admin-tab-pane {
            display: none;
        }

        .admin-tab-pane.active {
            display: block;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4facfe;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .registration-closed {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .randomize-btn, .copy-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .copy-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .randomize-btn:hover, .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .randomize-btn:disabled, .copy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .chances-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .chance-item {
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 2px;
            border-radius: 4px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px 15px;
            }
            
            .admin-container {
                margin: 10px;
            }
        }

        #globalStatus {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
        }
    </style>
</head>
<body>
    <!-- Глобальный статус -->
    <div id="globalStatus"></div>

    <!-- Firebase конфигурация -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBHnFvokO7bnVhm0NVZFEqjZE-qJlmYUQI",
            authDomain: "test-7b8b5.firebaseapp.com",
            databaseURL: "https://test-7b8b5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "test-7b8b5",
            storageBucket: "test-7b8b5.appspot.com",
            messagingSenderId: "639149527829",
            appId: "1:639149527829:web:9a6ea4af87e8ecc0c5a1f6"
        };

        let app, db;
        let isFirebaseConnected = false;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            isFirebaseConnected = true;
            
            window.db = db;
            window.dbRef = ref;
            window.dbPush = push;
            window.dbSet = set;
            window.dbOnValue = onValue;
            window.dbRemove = remove;
            window.dbUpdate = update;
            window.isFirebaseConnected = true;
            
            console.log("✅ Firebase подключен успешно");
            
        } catch (error) {
            console.error("❌ Ошибка подключения Firebase:", error);
            isFirebaseConnected = false;
            window.isFirebaseConnected = false;
        }
        
        // Инициализация приложения в любом случае
        setTimeout(() => {
            if (typeof window.initApp === 'function') {
                window.initApp();
            } else {
                console.log("⏰ Ожидание загрузки основного скрипта...");
                setTimeout(() => {
                    if (typeof window.initApp === 'function') {
                        window.initApp();
                    }
                }, 1000);
            }
        }, 100);
    </script>

    <!-- Основной контейнер регистрации -->
    <div class="container" id="mainContainer">
        <div class="card">
            <div class="header">
                <h1>🎉 Фестиваль</h1>
                <p>Регистрация участников</p>
            </div>

            <!-- Шаг загрузки -->
            <div class="step active" id="loadingStep">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">⏳</div>
                    <h2 style="color: #4facfe; margin-bottom: 15px;">Загрузка...</h2>
                    <p style="color: #666;">Подключение к системе регистрации</p>
                </div>
            </div>

            <!-- Шаг ошибки -->
            <div class="step" id="errorStep">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">⚠️</div>
                    <h2 style="color: #dc3545; margin-bottom: 15px;">Ошибка подключения</h2>
                    <p style="color: #666; margin-bottom: 20px;">Не удалось загрузить данные участников</p>
                    <div class="status error" id="errorMessage"></div>
                    <button class="btn btn-primary" onclick="location.reload()">
                        🔄 Попробовать снова
                    </button>
                </div>
            </div>

            <!-- Регистрация закрыта -->
            <div class="step" id="registrationClosedStep">
                <div class="registration-closed">
                    <div style="font-size: 3rem; margin-bottom: 15px;">🔒</div>
                    <h2 style="margin-bottom: 15px;">Регистрация закрыта</h2>
                    <p>Организаторы временно приостановили регистрацию участников.</p>
                    <p style="margin-top: 10px;">Попробуйте позже или обратитесь к администратору.</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
                        🔄 Обновить страницу
                    </button>
                </div>
            </div>

            <!-- Шаг 1: Выбор консультанта -->
            <div class="step" id="step1">
                <div class="progress">
                    <div class="progress-bar" style="width: 25%"></div>
                </div>
                                
                <h2 style="margin-bottom: 10px;">👤 Ваш консультант</h2>
                <p style="color: #666; margin-bottom: 20px;">Выберите консультанта, который пригласил вас на фестиваль</p>
                
                <div class="form-group">
                    <input type="text" class="search-box" id="consultantSearch" placeholder="🔍 Поиск консультанта...">
                    <!-- Мобильная версия -->
                    <div id="consultantMobileList" style="display: block;">
                        <div id="consultantCards" class="consultants-grid"></div>
                    </div>
                    <!-- ПК версия (скрыта на мобильных) -->
                    <select id="consultantSelect" size="5" style="height: 160px; display: none;">
                        <option value="">Выберите консультанта...</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" id="nextStep1" onclick="nextStep(1)" disabled>
                    <span class="emoji">➡️</span>Далее
                </button>
            </div>

            <!-- Шаг 2: Выбор участника -->
            <div class="step" id="step2">
                <div class="progress">
                    <div class="progress-bar" style="width: 50%"></div>
                </div>
                
                <h2 style="margin-bottom: 10px;">👥 Выбор участника</h2>
                <p style="color: #666; margin-bottom: 20px;">Найдите себя в списке</p>
                
                <div class="form-group">
                    <input type="text" class="search-box" id="participantSearch" placeholder="🔍 Поиск по имени...">
                    <div id="participantMobileList" style="display: block;">
                        <div id="participantCards" class="consultants-grid"></div>
                    </div>
                    <select id="participantSelect" size="5" style="height: 160px; display: none;">
                        <option value="">Выберите участника...</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="previousStep(2)" style="flex: 1;">
                        <span class="emoji">⬅️</span>Назад
                    </button>
                    <button class="btn btn-primary" id="nextStep2" onclick="nextStep(2)" disabled style="flex: 2;">
                        <span class="emoji">➡️</span>Далее
                    </button>
                </div>
            </div>

            <!-- Шаг 3: Подтверждение -->
            <div class="step" id="step3">
                <div class="progress">
                    <div class="progress-bar" style="width: 75%"></div>
                </div>
                
                <h2 style="margin-bottom: 20px;">✅ Подтверждение</h2>
                
                <div class="participant-info">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 2rem; margin-right: 15px;">👤</div>
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem;" id="confirmName">Имя участника</div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <span>Консультант: </span><span id="confirmConsultant">Имя консультанта</span>
                            </div>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                        Вы подтверждаете свое участие в фестивале
                    </div>
                </div>
                
                <div class="status warning">
                    ⚠️ <strong>Внимание!</strong> После регистрации изменить данные будет невозможно
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="previousStep(3)" style="flex: 1;">
                        <span class="emoji">⬅️</span>Назад
                    </button>
                    <button class="btn btn-success" onclick="registerParticipant()" id="registerBtn" style="flex: 2;">
                        <span class="emoji">🎉</span>Зарегистрироваться на фестивале
                    </button>
                </div>
            </div>

            <!-- Шаг 4: Успешная регистрация -->
            <div class="step" id="step4">
                <div class="progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
                
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">🎉</div>
                    <h2 style="color: #28a745; margin-bottom: 15px;">Регистрация завершена!</h2>
                    <p style="color: #666; margin-bottom: 15px;">Добро пожаловать на фестиваль!</p>
                    
                    <div class="status success">
                        <strong>✅ Вы успешно зарегистрированы</strong><br>
                        <span id="registrationTime"></span>
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #e3f7ff; border-radius: 12px;">
                        <strong>🎉 Вы успешно зарегистрированы на фестивале!</strong><br>
                        <span style="color: #666;">Добро пожаловать и хорошего времяпровождения!</span>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="resetForm()">
                        👥 Зарегистрировать другого участника
                    </button>
                </div>
            </div>

            <!-- Шаг 5: Уже зарегистрирован -->
            <div class="step" id="step5">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">✅</div>
                    <h2 style="color: #17a2b8; margin-bottom: 15px;">Вы уже зарегистрированы!</h2>
                    <p style="color: #666; margin-bottom: 20px;">Этот участник уже прошел регистрацию на фестиваль</p>
                    
                    <div class="status info" id="alreadyRegisteredInfo">
                        <strong>Данные регистрации:</strong><br>
                        <span id="existingRegistrationInfo"></span>
                    </div>
                    
                    <button class="btn btn-primary" onclick="resetForm()">
                        👥 Зарегистрировать другого участника
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Панель администратора (отдельный контейнер ниже) -->
    <div class="admin-container" id="adminContainer">
        <div class="header" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); padding: 15px;">
            <h1 style="font-size: 1.4rem; margin-bottom: 5px;">🔧 Администратор</h1>
            <p style="font-size: 0.85rem;">Панель управления</p>
        </div>
        
        <div class="content">
            <!-- Форма входа в админку -->
            <div id="adminLoginSection" class="admin-login-section">
                <div style="font-size: 2rem; margin-bottom: 10px;">🔑</div>
                <h3 style="margin-bottom: 10px; color: #333;">Вход администратора</h3>
                <p style="color: #666; margin-bottom: 15px;">Введите пароль для управления</p>
                
                <div style="margin-bottom: 12px;">
                    <input type="password" id="adminPasswordInput" placeholder="Пароль" 
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                </div>
                
                <button class="btn btn-primary" onclick="loginAdmin()" style="margin-bottom: 8px; font-size: 0.9rem; padding: 12px;">
                    🔓 Войти
                </button>
                
                <div id="loginError" style="display: none; margin-top: 10px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 6px; font-size: 0.8rem;"></div>
            </div>
            
            <!-- Главная админ-панель -->
            <div id="adminPanel" style="display: none;">
                <div style="background: #e8f5e8; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>🔓 Вход выполнен</strong>
                        <button onclick="logoutAdmin()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            🚪 Выйти
                        </button>
                    </div>
                    <div id="adminStats" style="font-size: 0.9rem; color: #155724;"></div>
                </div>
                
                <!-- Навигация -->
                <div class="admin-nav">
                    <button class="admin-nav-item active" onclick="showAdminTab('control')">🎛️ Управление</button>
                    <button class="admin-nav-item" onclick="showAdminTab('preview')">👁️ Превью</button>
                    <button class="admin-nav-item" onclick="showAdminTab('settings')">⚙️ Настройки</button>
                </div>
                
                <!-- Контент табов -->
                <div class="admin-tab-content">
                    <!-- Управление -->
                    <div id="controlTab" class="admin-tab-pane active">
                        <h3 style="margin-bottom: 15px;">📥 Загрузка данных</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; margin-bottom: 8px; display: block;">📄 Выберите файл Excel:</label>
                            <input type="file" id="dataFileInput" accept=".xlsx,.xls" style="font-size: 0.9rem; padding: 10px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="loadParticipantsData()" style="font-size: 0.9rem; padding: 12px;">
                                📥 Загрузить данные
                            </button>
                            <button class="btn btn-success" onclick="exportRegistrations()" style="font-size: 0.9rem; padding: 12px;">
                                📊 Экспорт результатов
                            </button>
                        </div>

                        <!-- Управление регистрацией -->
                        <div style="border: 2px solid #ffc107; background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>🎯 Управление регистрацией</strong>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                        <span id="registrationStatusText">Регистрация открыта</span>
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="registrationToggle" checked onchange="toggleRegistration()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.8rem; color: #856404;">
                                <strong>Внимание:</strong> При отключении пользователи не смогут регистрироваться<br>
                                <span id="firebaseStatus" style="font-size: 0.75rem; color: #666;"></span>
                            </div>
                        </div>
                        
                        <button class="btn btn-danger" onclick="clearAllRegistrations()" style="font-size: 0.9rem; padding: 12px;">
                            🗑️ Сбросить все регистрации
                        </button>
                        
                        <!-- Управление отдельными регистрациями -->
                        <div style="margin-top: 20px;">
                            <h4>👥 Зарегистрированные участники</h4>
                            <div id="registrationsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px;"></div>
                        </div>
                    </div>
                    
                    <!-- Превью -->
                    <div id="previewTab" class="admin-tab-pane">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;" id="previewStats"></div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>🎲 Шансы</h3>
                            <div id="chancesPreview"></div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>👥 Консультанты</h3>
                            <div id="consultantsPreview"></div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>⚖️ Вес</h3>
                            <div id="weightPreview"></div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>🏅 Медали</h3>
                            <div id="medalsPreview"></div>
                        </div>
                    </div>
                    
                    <!-- Настройки -->
                    <div id="settingsTab" class="admin-tab-pane">
                        <h3 style="margin-bottom: 15px;">🔐 Смена пароля администратора</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; margin-bottom: 8px; display: block;">🔑 Новый пароль:</label>
                            <input type="password" id="newAdminPassword" placeholder="Введите новый пароль" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <button class="btn btn-primary" onclick="changeAdminPassword()" style="font-size: 0.9rem; padding: 12px;">
                            💾 Сохранить новый пароль
                        </button>
                        
                        <div style="margin-top: 20px; padding: 10px; background: #e3f7ff; border-radius: 8px; font-size: 0.85rem; color: #0c5460;">
                            <strong>💡 Совет:</strong> Используйте надежный пароль из букв, цифр и символов
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let participantsData = [];
        let consultantsData = {};
        let registrationsData = {};
        let currentStep = 'loadingStep';
        let selectedConsultant = null;
        let selectedParticipant = null;
        let isAdminAuthenticated = false;
        let registrationEnabled = true;
        let adminPassword = 'admin123';

        // Основная функция инициализации
        window.initApp = async function() {
            console.log("🚀 Инициализация приложения...");
            
            try {
                // Загружаем настройки администратора
                if (window.isFirebaseConnected) {
                    try {
                        await loadAdminSettings();
                    } catch (error) {
                        console.warn("⚠️ Не удалось загрузить настройки админа:", error);
                    }
                }
                
                // Пытаемся загрузить данные участников из разных источников
                const loadSuccess = await loadParticipantsFromSources();
                
                if (loadSuccess) {
                    // Загружаем регистрации из Firebase
                    if (window.isFirebaseConnected) {
                        try {
                            await loadRegistrationsFromFirebase();
                        } catch (error) {
                            console.warn("⚠️ Не удалось загрузить регистрации:", error);
                        }
                    }
                    
                    // Проверяем, открыта ли регистрация
                    if (!registrationEnabled) {
                        showStep('registrationClosedStep');
                    } else {
                        showStep('step1');
                    }
                    
                    setupEventListeners();
                    updateUI();
                    console.log("✅ Приложение инициализировано успешно");
                } else {
                    throw new Error("Не удалось загрузить данные участников");
                }
                
            } catch (error) {
                console.error("❌ Ошибка инициализации:", error);
                document.getElementById('errorMessage').textContent = error.message;
                showStep('errorStep');
            }
        };

        // Принудительная инициализация если Firebase не загрузился
        setTimeout(() => {
            if (currentStep === 'loadingStep') {
                console.log("⏰ Принудительная инициализация через 3 секунды...");
                window.initApp();
            }
        }, 3000);

        // Загрузка данных участников из разных источников
        async function loadParticipantsFromSources() {
            // Убираем демо-данные, требуем загрузку файла
            if (participantsData.length === 0) {
                console.log("📋 Данные участников не загружены. Требуется загрузка Excel файла.");
                showStep('errorStep');
                document.getElementById('errorMessage').innerHTML = `
                    <strong>Данные участников не загружены</strong><br>
                    Необходимо загрузить Excel файл с данными участников через админ-панель.<br><br>
                    <small>Войдите как администратор (пароль: admin123) и загрузите файл в разделе "Управление"</small>
                `;
                return false;
            }
            
            return true;
        }

        // Убираем загрузку демо данных
        async function loadDemoData() {
            // Возвращаем false, чтобы не загружать демо-данные
            return false;
        }

        // Функции для работы с Firebase
        async function loadRegistrationsFromFirebase() {
            if (!window.isFirebaseConnected) return;
            
            try {
                const registrationsRef = window.dbRef(window.db, 'registrations');
                
                return new Promise((resolve) => {
                    window.dbOnValue(registrationsRef, (snapshot) => {
                        const data = snapshot.val();
                        registrationsData = data || {};
                        console.log("📥 Регистрации загружены:", Object.keys(registrationsData).length);
                        
                        // Обновляем UI если админ панель открыта
                        if (isAdminAuthenticated) {
                            updateAdminPreview();
                            updateAdminStats();
                            updateRegistrationsList();
                        }
                        
                        resolve();
                    });
                });
            } catch (error) {
                console.error("Ошибка загрузки регистраций:", error);
            }
        }

        async function saveRegistrationToFirebase(participantData) {
            if (!window.isFirebaseConnected) {
                console.warn("Firebase не подключен, сохранение локально");
                registrationsData[participantData.id] = participantData;
                return;
            }
            
            try {
                const registrationRef = window.dbRef(window.db, `registrations/${participantData.id}`);
                await window.dbSet(registrationRef, participantData);
                console.log("✅ Регистрация сохранена в Firebase");
            } catch (error) {
                console.error("Ошибка сохранения регистрации:", error);
                throw error;
            }
        }

        async function loadAdminSettings() {
            if (!window.isFirebaseConnected) return;
            
            try {
                const settingsRef = window.dbRef(window.db, 'admin_settings');
                
                return new Promise((resolve) => {
                    window.dbOnValue(settingsRef, (snapshot) => {
                        const settings = snapshot.val();
                        if (settings) {
                            registrationEnabled = settings.registrationEnabled !== undefined ? settings.registrationEnabled : true;
                            adminPassword = settings.adminPassword || 'admin123';
                            
                            // Обновляем UI
                            const toggle = document.getElementById('registrationToggle');
                            if (toggle) toggle.checked = registrationEnabled;
                            
                            updateRegistrationStatus();
                        }
                        resolve();
                    });
                });
            } catch (error) {
                console.error("Ошибка загрузки настроек:", error);
            }
        }

        async function saveAdminSettings() {
            if (!window.isFirebaseConnected) return;
            
            try {
                const settingsRef = window.dbRef(window.db, 'admin_settings');
                await window.dbSet(settingsRef, {
                    registrationEnabled: registrationEnabled,
                    adminPassword: adminPassword,
                    lastUpdated: new Date().toISOString()
                });
                console.log("✅ Настройки админа сохранены");
            } catch (error) {
                console.error("Ошибка сохранения настроек:", error);
            }
        }

        // Основные функции навигации
        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
            currentStep = stepId;
        }

        function nextStep(step) {
            if (step === 1) {
                if (!selectedConsultant) {
                    showGlobalStatus('Выберите консультанта', 'warning');
                    return;
                }
                loadParticipantsByConsultant(selectedConsultant);
                showStep('step2');
            } else if (step === 2) {
                if (!selectedParticipant) {
                    showGlobalStatus('Выберите участника', 'warning');
                    return;
                }
                
                // Проверяем, не зарегистрирован ли уже этот участник
                if (registrationsData[selectedParticipant.id]) {
                    showExistingRegistration(registrationsData[selectedParticipant.id]);
                    showStep('step5');
                    return;
                }
                
                updateConfirmationStep();
                showStep('step3');
            }
        }

        function previousStep(step) {
            if (step === 2) {
                showStep('step1');
            } else if (step === 3) {
                showStep('step2');
            }
        }

        // Функции выбора консультанта
        function setupConsultantSelection() {
            const consultantCards = document.getElementById('consultantCards');
            const consultantSelect = document.getElementById('consultantSelect');
            const searchInput = document.getElementById('consultantSearch');
            
            // Очищаем контейнеры
            consultantCards.innerHTML = '';
            consultantSelect.innerHTML = '<option value="">Выберите консультанта...</option>';
            
            // Заполняем список консультантов
            Object.keys(consultantsData).forEach(consultant => {
                // Мобильная версия (карточки)
                const card = document.createElement('div');
                card.className = 'consultant-card';
                card.textContent = consultant;
                card.onclick = () => selectConsultant(consultant, card);
                consultantCards.appendChild(card);
                
                // ПК версия (select)
                const option = document.createElement('option');
                option.value = consultant;
                option.textContent = consultant;
                consultantSelect.appendChild(option);
            });
            
            // Обработчик поиска
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.consultant-card').forEach(card => {
                    const consultantName = card.textContent.toLowerCase();
                    if (consultantName.includes(searchTerm)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            };
            
            // Обработчик select для ПК
            consultantSelect.onchange = (e) => {
                if (e.target.value) {
                    selectConsultant(e.target.value);
                }
            };
        }

        function selectConsultant(consultant, cardElement = null) {
            selectedConsultant = consultant;
            
            // Обновляем выбор в карточках
            document.querySelectorAll('.consultant-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (cardElement) {
                cardElement.classList.add('selected');
            } else {
                // Находим и выделяем нужную карточку
                document.querySelectorAll('.consultant-card').forEach(card => {
                    if (card.textContent === consultant) {
                        card.classList.add('selected');
                    }
                });
            }
            
            // Обновляем select
            document.getElementById('consultantSelect').value = consultant;
            
            // Активируем кнопку "Далее"
            document.getElementById('nextStep1').disabled = false;
        }

        // Функции выбора участника
        function loadParticipantsByConsultant(consultant) {
            const participants = consultantsData[consultant] || [];
            const participantCards = document.getElementById('participantCards');
            const participantSelect = document.getElementById('participantSelect');
            const searchInput = document.getElementById('participantSearch');
            
            // Очищаем контейнеры
            participantCards.innerHTML = '';
            participantSelect.innerHTML = '<option value="">Выберите участника...</option>';
            selectedParticipant = null;
            document.getElementById('nextStep2').disabled = true;
            
            // Заполняем список участников
            participants.forEach(participant => {
                // Мобильная версия (карточки)
                const card = document.createElement('div');
                card.className = 'consultant-card';
                
                // Проверяем, зарегистрирован ли участник
                const isRegistered = registrationsData[participant.id];
                if (isRegistered) {
                    card.style.background = '#d4edda';
                    card.style.borderColor = '#c3e6cb';
                    card.innerHTML = `${participant.name}<br><small style="color: #155724;">✅ Зарегистрирован</small>`;
                } else {
                    card.textContent = participant.name;
                }
                
                card.onclick = () => selectParticipant(participant, card);
                participantCards.appendChild(card);
                
                // ПК версия (select)
                const option = document.createElement('option');
                option.value = participant.id;
                option.textContent = isRegistered ? `${participant.name} (✅ Зарегистрирован)` : participant.name;
                participantSelect.appendChild(option);
            });
            
            // Обработчик поиска
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#participantCards .consultant-card').forEach(card => {
                    const participantName = card.textContent.toLowerCase();
                    if (participantName.includes(searchTerm)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            };
            
            // Обработчик select для ПК
            participantSelect.onchange = (e) => {
                if (e.target.value) {
                    const participant = participants.find(p => p.id == e.target.value);
                    selectParticipant(participant);
                }
            };
        }

        function selectParticipant(participant, cardElement = null) {
            selectedParticipant = participant;
            
            // Обновляем выбор в карточках
            document.querySelectorAll('#participantCards .consultant-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (cardElement) {
                cardElement.classList.add('selected');
            }
            
            // Обновляем select
            document.getElementById('participantSelect').value = participant.id;
            
            // Активируем кнопку "Далее"
            document.getElementById('nextStep2').disabled = false;
        }

        // Функции подтверждения и регистрации
        function updateConfirmationStep() {
            document.getElementById('confirmName').textContent = selectedParticipant.name;
            document.getElementById('confirmConsultant').textContent = selectedConsultant;
        }

        async function registerParticipant() {
            try {
                document.getElementById('registerBtn').disabled = true;
                
                const registrationData = {
                    id: selectedParticipant.id,
                    name: selectedParticipant.name,
                    consultant: selectedConsultant,
                    chances: selectedParticipant.chances,
                    weight: selectedParticipant.weight || 0,
                    medal: selectedParticipant.medal || 'Участник',
                    registrationTime: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                await saveRegistrationToFirebase(registrationData);
                registrationsData[selectedParticipant.id] = registrationData;
                
                // Показываем время регистрации
                const registrationTime = new Date().toLocaleString('ru-RU');
                document.getElementById('registrationTime').textContent = `Время регистрации: ${registrationTime}`;
                
                showStep('step4');
                
                // Обновляем админ панель если открыта
                if (isAdminAuthenticated) {
                    updateAdminPreview();
                    updateAdminStats();
                    updateRegistrationsList();
                }
                
            } catch (error) {
                console.error("Ошибка регистрации:", error);
                showGlobalStatus('Ошибка регистрации: ' + error.message, 'error');
                document.getElementById('registerBtn').disabled = false;
            }
        }

        function showExistingRegistration(registration) {
            const registrationTime = new Date(registration.registrationTime).toLocaleString('ru-RU');
            document.getElementById('existingRegistrationInfo').innerHTML = `
                <strong>Имя:</strong> ${registration.name}<br>
                <strong>Консультант:</strong> ${registration.consultant}<br>
                <strong>Время регистрации:</strong> ${registrationTime}
            `;
        }

        function resetForm() {
            selectedConsultant = null;
            selectedParticipant = null;
            
            // Сбрасываем все формы
            document.getElementById('consultantSearch').value = '';
            document.getElementById('participantSearch').value = '';
            document.querySelectorAll('.consultant-card').forEach(card => {
                card.classList.remove('selected', 'hidden');
            });
            
            // Сбрасываем кнопки
            document.getElementById('nextStep1').disabled = true;
            document.getElementById('nextStep2').disabled = true;
            document.getElementById('registerBtn').disabled = false;
            
            // Возвращаемся к первому шагу
            showStep('step1');
        }

        // Функции администратора
        function loginAdmin() {
            const inputPassword = document.getElementById('adminPasswordInput').value;
            
            if (inputPassword === adminPassword) {
                isAdminAuthenticated = true;
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                updateAdminStats();
                updateAdminPreview();
                updateRegistrationsList();
                showGlobalStatus('Вход администратора выполнен', 'success');
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'Неверный пароль';
                errorDiv.style.display = 'block';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
            
            document.getElementById('adminPasswordInput').value = '';
        }

        function logoutAdmin() {
            isAdminAuthenticated = false;
            document.getElementById('adminLoginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            showGlobalStatus('Выход администратора выполнен', 'info');
        }

        function showAdminTab(tabName) {
            // Переключение активной вкладки в навигации
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Переключение контента
            document.querySelectorAll('.admin-tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Обновляем контент при переключении на превью
            if (tabName === 'preview') {
                updateAdminPreview();
            }
        }

        async function toggleRegistration() {
            registrationEnabled = document.getElementById('registrationToggle').checked;
            updateRegistrationStatus();
            
            try {
                await saveAdminSettings();
                showGlobalStatus(
                    registrationEnabled ? 'Регистрация открыта' : 'Регистрация закрыта', 
                    registrationEnabled ? 'success' : 'warning'
                );
            } catch (error) {
                console.error("Ошибка сохранения настроек:", error);
                showGlobalStatus('Ошибка сохранения настроек', 'error');
            }
        }

        function updateRegistrationStatus() {
            const statusText = document.getElementById('registrationStatusText');
            if (statusText) {
                statusText.textContent = registrationEnabled ? 'Регистрация открыта' : 'Регистрация закрыта';
                statusText.style.color = registrationEnabled ? '#28a745' : '#dc3545';
            }
        }

        async function clearAllRegistrations() {
            if (!confirm('Вы уверены, что хотите удалить ВСЕ регистрации? Это действие нельзя отменить!')) {
                return;
            }
            
            try {
                if (window.isFirebaseConnected) {
                    const registrationsRef = window.dbRef(window.db, 'registrations');
                    await window.dbRemove(registrationsRef);
                }
                
                registrationsData = {};
                updateAdminPreview();
                updateAdminStats();
                updateRegistrationsList();
                showGlobalStatus('Все регистрации удалены', 'success');
                
            } catch (error) {
                console.error("Ошибка удаления регистраций:", error);
                showGlobalStatus('Ошибка удаления регистраций', 'error');
            }
        }

        async function removeRegistration(participantId) {
            if (!confirm('Удалить эту регистрацию?')) {
                return;
            }
            
            try {
                if (window.isFirebaseConnected) {
                    const registrationRef = window.dbRef(window.db, `registrations/${participantId}`);
                    await window.dbRemove(registrationRef);
                }
                
                delete registrationsData[participantId];
                updateAdminPreview();
                updateAdminStats();
                updateRegistrationsList();
                showGlobalStatus('Регистрация удалена', 'success');
                
            } catch (error) {
                console.error("Ошибка удаления регистрации:", error);
                showGlobalStatus('Ошибка удаления регистрации', 'error');
            }
        }

        async function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            
            if (!newPassword) {
                showGlobalStatus('Введите новый пароль', 'warning');
                return;
            }
            
            if (newPassword.length < 4) {
                showGlobalStatus('Пароль должен содержать минимум 4 символа', 'warning');
                return;
            }
            
            try {
                adminPassword = newPassword;
                await saveAdminSettings();
                
                document.getElementById('newAdminPassword').value = '';
                showGlobalStatus('Пароль администратора изменен', 'success');
                
            } catch (error) {
                console.error("Ошибка смены пароля:", error);
                showGlobalStatus('Ошибка смены пароля: ' + error.message, 'error');
            }
        }

        function updateAdminStats() {
            const totalParticipants = participantsData.length;
            const registeredCount = Object.keys(registrationsData).length;
            const totalChances = participantsData.reduce((sum, p) => sum + p.chances, 0);
            const registeredChances = Object.values(registrationsData).reduce((sum, r) => sum + r.chances, 0);
            
            const statsElement = document.getElementById('adminStats');
            if (statsElement) {
                statsElement.innerHTML = `
                    <strong>📊 Статистика регистрации:</strong><br>
                    👥 Зарегистрировано: ${registeredCount} из ${totalParticipants} 
                    (${totalParticipants > 0 ? Math.round(registeredCount / totalParticipants * 100) : 0}%)<br>
                    🎲 Шансы: ${registeredChances} из ${totalChances}<br>
                    📈 Консультантов: ${Object.keys(consultantsData).length}<br>
                    🔥 Статус Firebase: ${window.isFirebaseConnected ? '✅ Подключен' : '❌ Отключен'}
                `;
            }
        }

        function updateRegistrationsList() {
            const listElement = document.getElementById('registrationsList');
            if (!listElement) return;
            
            const registrations = Object.values(registrationsData)
                .sort((a, b) => new Date(b.registrationTime) - new Date(a.registrationTime));
            
            if (registrations.length === 0) {
                listElement.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Нет зарегистрированных участников</div>';
                return;
            }
            
            let html = '';
            registrations.forEach(reg => {
                const registrationTime = new Date(reg.registrationTime).toLocaleString('ru-RU');
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #f9f9f9; margin-bottom: 5px; border-radius: 5px;">
                        <div>
                            <div style="font-weight: bold;">${reg.name}</div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${reg.consultant} • ${registrationTime} • 
                                ${reg.chances} шанс(ов) • ${reg.weight || 0} кг • ${reg.medal || 'Участник'}
                            </div>
                        </div>
                        <button onclick="removeRegistration(${reg.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            🗑️ Удалить
                        </button>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }

        function updateAdminPreview() {
            updatePreviewStats();
            updateChancesPreview();
            updateConsultantsPreview();
            updateWeightPreview();
            updateMedalsPreview();
        }

        function updatePreviewStats() {
            const registeredCount = Object.keys(registrationsData).length;
            const totalChances = Object.values(registrationsData).reduce((sum, r) => sum + r.chances, 0);
            const totalWeight = Object.values(registrationsData).reduce((sum, r) => sum + (r.weight || 0), 0);
            
            document.getElementById('previewStats').innerHTML = `
                <div style="text-align: center; padding: 10px; background: #e3f7ff; border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #4facfe;">${registeredCount}</div>
                    <div style="font-size: 0.8rem; color: #666;">Зарегистрировано</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">${totalChances}</div>
                    <div style="font-size: 0.8rem; color: #666;">Честных шансов</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #fff3cd; border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #856404;">${totalWeight}</div>
                    <div style="font-size: 0.8rem; color: #666;">Кг зарегистрированных</div>
                </div>
            `;
        }

        function updateChancesPreview() {
            const chancesPreview = document.getElementById('chancesPreview');
            if (!chancesPreview) return;
            
            const lotteryEntries = [];
            Object.values(registrationsData).forEach(reg => {
                for (let i = 0; i < reg.chances; i++) {
                    lotteryEntries.push(reg.name);
                }
            });
            
            let html = '';
            
            if (lotteryEntries.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">Пока нет зарегистрированных участников</div>';
            } else {
                html += '<div style="margin-bottom: 15px; text-align: center;">';
                html += '<button class="randomize-btn" onclick="randomizeChancesList()">🎲 Перемешать список</button>';
                
                // Проверяем, есть ли данные для копирования
                const displayList = window.randomizedChancesList || lotteryEntries;
                const hasDataToCopy = displayList.length > 0;
                
                html += `<button class="copy-btn" onclick="copyChancesToClipboard()" ${hasDataToCopy ? '' : 'disabled'}>📋 Копировать</button>`;
                html += '</div>';
                
                html += '<h3>Предварительный просмотр лотереи:</h3>';
                
                html += '<div class="chances-list">';
                displayList.forEach((name) => {
                    html += `<div class="chance-item">${name}</div>`;
                });
                html += '</div>';
                
                html += `<div style="margin-top: 15px; padding: 10px; background: #e3f7ff; border-radius: 5px; color: #0c5460; font-size: 0.9rem;">
                    📊 Всего записей в лотерее: ${displayList.length}<br>
                    ${window.randomizedChancesList ? '🎲 Список перемешан' : '📋 Исходный порядок'}
                </div>`;
            }
            
            chancesPreview.innerHTML = html;
        }

        // ИСПРАВЛЕННАЯ функция рандомизации
        function randomizeChancesList() {
            const lotteryEntries = [];
            Object.values(registrationsData).forEach(reg => {
                for (let i = 0; i < reg.chances; i++) {
                    lotteryEntries.push(reg.name);
                }
            });
            
            if (lotteryEntries.length > 0) {
                // Создаем рандомизированный список и сохраняем глобально
                window.randomizedChancesList = shuffleArray(lotteryEntries);
                updateChancesPreview();
                showGlobalStatus('Список лотереи перемешан! 🎲', 'success');
                console.log('Список перемешан, новый порядок:', window.randomizedChancesList.slice(0, 10));
            } else {
                showGlobalStatus('Нет участников для перемешивания', 'warning');
            }
        }

        // ИСПРАВЛЕННАЯ функция копирования списка шансов в буфер обмена
        function copyChancesToClipboard() {
            try {
                const lotteryEntries = [];
                Object.values(registrationsData).forEach(reg => {
                    for (let i = 0; i < reg.chances; i++) {
                        lotteryEntries.push(reg.name);
                    }
                });
                
                // Используем рандомизированный список, если он есть, иначе исходный
                const displayList = window.randomizedChancesList || lotteryEntries;
                
                if (displayList.length === 0) {
                    showGlobalStatus('Нет участников для копирования', 'warning');
                    return;
                }
                
                // Формируем текст для копирования (каждое имя на новой строке)
                const textToCopy = displayList.join('\n');
                
                // Копируем в буфер обмена
                if (navigator.clipboard && window.isSecureContext) {
                    // Современный способ для HTTPS
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        const listType = window.randomizedChancesList ? 'перемешанный' : 'исходный';
                        showGlobalStatus(`📋 Скопировано ${displayList.length} записей (${listType} список)`, 'success');
                        console.log('Список скопирован в буфер:', displayList.slice(0, 5), '...');
                    }).catch(error => {
                        console.error('Ошибка копирования:', error);
                        showFallbackCopyModal(textToCopy);
                    });
                } else {
                    // Fallback для HTTP или старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        textArea.remove();
                        const listType = window.randomizedChancesList ? 'перемешанный' : 'исходный';
                        showGlobalStatus(`📋 Скопировано ${displayList.length} записей (${listType} список)`, 'success');
                        console.log('Список скопирован в буфер:', displayList.slice(0, 5), '...');
                    } catch (err) {
                        textArea.remove();
                        showFallbackCopyModal(textToCopy);
                    }
                }
                
            } catch (error) {
                console.error('Ошибка копирования:', error);
                showGlobalStatus('Ошибка копирования в буфер обмена', 'error');
            }
        }

        function showFallbackCopyModal(textToCopy) {
            // Создаем модальное окно с текстом для ручного копирования
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 9999; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto;">
                    <h3>Скопируйте текст вручную:</h3>
                    <textarea readonly style="width: 100%; height: 300px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${textToCopy}</textarea>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Закрыть</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Выделяем текст в textarea
            setTimeout(() => {
                const textarea = modal.querySelector('textarea');
                textarea.focus();
                textarea.select();
            }, 100);
        }

        // Вспомогательная функция для перемешивания массива
        function shuffleArray(array) {
            const shuffled = array.slice();
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            return shuffled;
        }

        function updateConsultantsPreview() {
            let html = '<h3>Клиенты по консультантам (зарегистрированные):</h3>';
            
            const consultantsByClients = Object.keys(consultantsData).map(consultant => {
                const participants = consultantsData[consultant];
                const registered = participants.filter(p => registrationsData[p.id]);
                return { consultant, participants, registered };
            }).sort((a, b) => b.registered.length - a.registered.length);
            
            if (consultantsByClients.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">Нет данных консультантов</div>';
            } else {
                consultantsByClients.forEach((data, index) => {
                    const consultantId = `consultant-${index}`;
                    html += `
                        <div style="margin-bottom: 15px;">
                            <div class="consultant-header" onclick="toggleConsultantClients('${consultantId}')" style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #ddd;">
                                <span><strong>${data.consultant}</strong> - ${data.registered.length} из ${data.participants.length} зарегистрировано</span>
                                <span id="icon-${consultantId}" style="float: right;">▶</span>
                            </div>
                            <div class="consultant-content" id="${consultantId}" style="display: none; padding: 10px; border: 1px solid #ddd; border-top: none;">
                    `;
                    
                    data.participants.forEach(participant => {
                        const isRegistered = registrationsData[participant.id];
                        html += `
                            <div style="padding: 3px 0; ${isRegistered ? 'color: #28a745; font-weight: 600;' : 'color: #dc3545;'}">
                                ${isRegistered ? '✅' : '❌'} ${participant.name}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('consultantsPreview').innerHTML = html;
        }

        function toggleConsultantClients(consultantId) {
            const content = document.getElementById(consultantId);
            const icon = document.getElementById(`icon-${consultantId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function updateWeightPreview() {
            let html = '<h3>Распределение по весу:</h3>';
            
            const registeredParticipants = Object.values(registrationsData);
            if (registeredParticipants.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">Нет зарегистрированных участников</div>';
            } else {
                const totalWeight = registeredParticipants.reduce((sum, p) => sum + (p.weight || 0), 0);
                const avgWeight = Math.round(totalWeight / registeredParticipants.length);
                
                html += `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <strong>📊 Общая статистика по весу:</strong><br>
                            Общий вес: ${totalWeight} кг<br>
                            Средний вес: ${avgWeight} кг<br>
                            Участников: ${registeredParticipants.length}
                        </div>
                    </div>
                `;
                
                // Сортируем по весу
                const sortedByWeight = registeredParticipants
                    .sort((a, b) => (b.weight || 0) - (a.weight || 0));
                
                html += '<div style="max-height: 300px; overflow-y: auto;">';
                sortedByWeight.forEach(participant => {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                            <span>${participant.name}</span>
                            <span style="font-weight: bold;">${participant.weight || 0} кг</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('weightPreview').innerHTML = html;
        }

        function updateMedalsPreview() {
            let html = '<h3>Распределение медалей:</h3>';
            
            const registeredParticipants = Object.values(registrationsData);
            if (registeredParticipants.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">Нет зарегистрированных участников</div>';
            } else {
                // Группируем по медалям
                const medalGroups = {};
                registeredParticipants.forEach(participant => {
                    const medal = participant.medal || 'Участник';
                    if (!medalGroups[medal]) {
                        medalGroups[medal] = [];
                    }
                    medalGroups[medal].push(participant);
                });
                
                // Сортируем группы медалей
                const medalOrder = ['Золото', 'Серебро', 'Бронза', 'Участник'];
                const sortedMedals = Object.keys(medalGroups).sort((a, b) => {
                    const aIndex = medalOrder.indexOf(a);
                    const bIndex = medalOrder.indexOf(b);
                    if (aIndex === -1) return 1;
                    if (bIndex === -1) return -1;
                    return aIndex - bIndex;
                });
                
                sortedMedals.forEach(medal => {
                    const participants = medalGroups[medal];
                    const medalIcon = {
                        'Золото': '🥇',
                        'Серебро': '🥈',
                        'Бронза': '🥉',
                        'Участник': '🏅'
                    }[medal] || '🏅';
                    
                    html += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                ${medalIcon} ${medal} (${participants.length})
                            </div>
                            <div style="padding: 10px; border: 1px solid #ddd; border-top: none;">
                    `;
                    
                    participants.forEach(participant => {
                        html += `
                            <div style="padding: 2px 0;">
                                • ${participant.name}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('medalsPreview').innerHTML = html;
        }

        // Функции загрузки данных из файла
        async function loadParticipantsData() {
            const fileInput = document.getElementById('dataFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showGlobalStatus('Выберите файл для загрузки', 'warning');
                return;
            }
            
            try {
                showGlobalStatus('Загрузка данных...', 'info');
                
                const data = await readExcelFile(file);
                processParticipantsData(data);
                
                showGlobalStatus('Данные успешно загружены', 'success');
                setupEventListeners();
                updateUI();
                
                // После загрузки данных показываем форму регистрации
                if (registrationEnabled) {
                    showStep('step1');
                } else {
                    showStep('registrationClosedStep');
                }
                
                if (isAdminAuthenticated) {
                    updateAdminStats();
                    updateAdminPreview();
                }
                
            } catch (error) {
                console.error("Ошибка загрузки файла:", error);
                showGlobalStatus('Ошибка загрузки файла: ' + error.message, 'error');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Ошибка чтения файла'));
                reader.readAsArrayBuffer(file);
            });
        }

        function processParticipantsData(data) {
            participantsData = data.map((row, index) => ({
                id: index + 1,
                name: row['Имя'] || row['Name'] || row['ФИО'] || 'Неизвестный участник',
                consultant: row['Консультант'] || row['Consultant'] || 'Неизвестный консультант',
                chances: parseInt(row['Шансы'] || row['Chances'] || 1),
                weight: parseFloat(row['Вес'] || row['Weight'] || 0),
                medal: row['Медаль'] || row['Medal'] || 'Участник'
            }));
            
            // Группируем по консультантам
            consultantsData = {};
            participantsData.forEach(participant => {
                if (!consultantsData[participant.consultant]) {
                    consultantsData[participant.consultant] = [];
                }
                consultantsData[participant.consultant].push(participant);
            });
            
            console.log("Загружено участников:", participantsData.length);
            console.log("Консультантов:", Object.keys(consultantsData).length);
        }

        function exportRegistrations() {
            if (Object.keys(registrationsData).length === 0) {
                showGlobalStatus('Нет данных для экспорта', 'warning');
                return;
            }
            
            try {
                const registrations = Object.values(registrationsData);
                const exportData = registrations.map(reg => ({
                    'ID': reg.id,
                    'Имя': reg.name,
                    'Консультант': reg.consultant,
                    'Шансы': reg.chances,
                    'Вес': reg.weight || 0,
                    'Медаль': reg.medal || 'Участник',
                    'Время регистрации': new Date(reg.registrationTime).toLocaleString('ru-RU')
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Регистрации');
                
                const fileName = `registrations_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showGlobalStatus('Данные экспортированы в файл ' + fileName, 'success');
                
            } catch (error) {
                console.error("Ошибка экспорта:", error);
                showGlobalStatus('Ошибка экспорта данных', 'error');
            }
        }

        // Функции настройки UI
        function setupEventListeners() {
            setupConsultantSelection();
            
            // Enter для админ пароля
            const adminPasswordInput = document.getElementById('adminPasswordInput');
            if (adminPasswordInput) {
                adminPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginAdmin();
                    }
                });
            }
        }

        function updateUI() {
            setupConsultantSelection();
            updateRegistrationStatus();
            
            // Обновляем статус Firebase
            const firebaseStatus = document.getElementById('firebaseStatus');
            if (firebaseStatus) {
                firebaseStatus.textContent = window.isFirebaseConnected ? 
                    '✅ Firebase подключен' : 
                    '⚠️ Firebase отключен (локальный режим)';
            }
        }

        function showGlobalStatus(message, type = 'info') {
            const statusElement = document.getElementById('globalStatus');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Периодическое обновление данных
        setInterval(async () => {
            if (window.isFirebaseConnected && window.db) {
                try {
                    await loadRegistrationsFromFirebase();
                    await loadAdminSettings();
                    
                    // Если регистрация была закрыта админом, переключаем на соответствующий экран
                    if (!registrationEnabled && !document.getElementById('registrationClosedStep').classList.contains('active') && !isAdminAuthenticated) {
                        showStep('registrationClosedStep');
                    }
                } catch (error) {
                    console.error("Ошибка автообновления:", error);
                }
            }
        }, 10000); // Обновление каждые 10 секунд
        
        // Делаем функции глобально доступными для HTML onclick
        window.randomizeChancesList = randomizeChancesList;
        window.copyChancesToClipboard = copyChancesToClipboard;
        window.removeRegistration = removeRegistration;
        window.toggleConsultantClients = toggleConsultantClients;
    </script>
    
    <!-- Подключение библиотеки для работы с Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
