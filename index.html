<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª—å</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .progress {
            background: #e9ecef;
            height: 8px;
            border-radius: 20px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #fafafa;
            margin-bottom: 15px;
        }

        .search-box:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .consultants-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .consultant-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            text-align: center;
        }

        .consultant-card:hover {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .consultant-card.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .consultant-card.hidden {
            display: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #97cbff;
        }

        .participant-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .emoji {
            margin-right: 8px;
        }

        .admin-container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .admin-login-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
        }

        .admin-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .admin-nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .admin-nav-item.active {
            background: white;
            border-bottom-color: #4facfe;
            font-weight: 600;
        }

        .admin-tab-content {
            padding: 20px;
        }

        .admin-tab-pane {
            display: none;
        }

        .admin-tab-pane.active {
            display: block;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4facfe;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .registration-closed {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .randomize-btn, .copy-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .copy-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .randomize-btn:hover, .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .randomize-btn:disabled, .copy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .chances-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .chance-item {
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 2px;
            border-radius: 4px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px 15px;
            }
            
            .admin-container {
                margin: 10px;
            }
        }

        #globalStatus {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
        }
    </style>
</head>
<body>
    <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å -->
    <div id="globalStatus"></div>

    <!-- Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBHnFvokO7bnVhm0NVZFEqjZE-qJlmYUQI",
            authDomain: "test-7b8b5.firebaseapp.com",
            databaseURL: "https://test-7b8b5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "test-7b8b5",
            storageBucket: "test-7b8b5.appspot.com",
            messagingSenderId: "639149527829",
            appId: "1:639149527829:web:9a6ea4af87e8ecc0c5a1f6"
        };

        let app, db;
        let isFirebaseConnected = false;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            isFirebaseConnected = true;
            
            window.db = db;
            window.dbRef = ref;
            window.dbPush = push;
            window.dbSet = set;
            window.dbOnValue = onValue;
            window.dbRemove = remove;
            window.dbUpdate = update;
            window.isFirebaseConnected = true;
            
            console.log("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ");
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Firebase:", error);
            isFirebaseConnected = false;
            window.isFirebaseConnected = false;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        setTimeout(() => {
            if (typeof window.initApp === 'function') {
                window.initApp();
            } else {
                console.log("‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞...");
                setTimeout(() => {
                    if (typeof window.initApp === 'function') {
                        window.initApp();
                    }
                }, 1000);
            }
        }, 100);
    </script>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="container" id="mainContainer">
        <div class="card">
            <div class="header">
                <h1>üéâ –§–µ—Å—Ç–∏–≤–∞–ª—å</h1>
                <p>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
            </div>

            <!-- –®–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="step active" id="loadingStep">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">‚è≥</div>
                    <h2 style="color: #4facfe; margin-bottom: 15px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <p style="color: #666;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
                </div>
            </div>

            <!-- –®–∞–≥ –æ—à–∏–±–∫–∏ -->
            <div class="step" id="errorStep">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <h2 style="color: #dc3545; margin-bottom: 15px;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
                    <p style="color: #666; margin-bottom: 20px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    <div class="status error" id="errorMessage"></div>
                    <button class="btn btn-primary" onclick="location.reload()">
                        üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            </div>

            <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ -->
            <div class="step" id="registrationClosedStep">
                <div class="registration-closed">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üîí</div>
                    <h2 style="margin-bottom: 15px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞</h2>
                    <p>–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
                    <p style="margin-top: 10px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ -->
            <div class="step" id="step1">
                <div class="progress">
                    <div class="progress-bar" style="width: 25%"></div>
                </div>
                                
                <h2 style="margin-bottom: 10px;">üë§ –í–∞—à –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</h2>
                <p style="color: #666; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–ª–∞—Å–∏–ª –≤–∞—Å –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª—å</p>
                
                <div class="form-group">
                    <input type="text" class="search-box" id="consultantSearch" placeholder="üîç –ü–æ–∏—Å–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞...">
                    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
                    <div id="consultantMobileList" style="display: block;">
                        <div id="consultantCards" class="consultants-grid"></div>
                    </div>
                    <!-- –ü–ö –≤–µ—Ä—Å–∏—è (—Å–∫—Ä—ã—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
                    <select id="consultantSelect" size="5" style="height: 160px; display: none;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞...</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" id="nextStep1" onclick="nextStep(1)" disabled>
                    <span class="emoji">‚û°Ô∏è</span>–î–∞–ª–µ–µ
                </button>
            </div>

            <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
            <div class="step" id="step2">
                <div class="progress">
                    <div class="progress-bar" style="width: 50%"></div>
                </div>
                
                <h2 style="margin-bottom: 10px;">üë• –í—ã–±–æ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
                <p style="color: #666; margin-bottom: 20px;">–ù–∞–π–¥–∏—Ç–µ —Å–µ–±—è –≤ —Å–ø–∏—Å–∫–µ</p>
                
                <div class="form-group">
                    <input type="text" class="search-box" id="participantSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
                    <div id="participantMobileList" style="display: block;">
                        <div id="participantCards" class="consultants-grid"></div>
                    </div>
                    <select id="participantSelect" size="5" style="height: 160px; display: none;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞...</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="previousStep(2)" style="flex: 1;">
                        <span class="emoji">‚¨ÖÔ∏è</span>–ù–∞–∑–∞–¥
                    </button>
                    <button class="btn btn-primary" id="nextStep2" onclick="nextStep(2)" disabled style="flex: 2;">
                        <span class="emoji">‚û°Ô∏è</span>–î–∞–ª–µ–µ
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 3: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
            <div class="step" id="step3">
                <div class="progress">
                    <div class="progress-bar" style="width: 75%"></div>
                </div>
                
                <h2 style="margin-bottom: 20px;">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
                
                <div class="participant-info">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 2rem; margin-right: 15px;">üë§</div>
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem;" id="confirmName">–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <span>–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç: </span><span id="confirmConsultant">–ò–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞</span>
                            </div>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                        –í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Å–≤–æ–µ —É—á–∞—Å—Ç–∏–µ –≤ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ
                    </div>
                </div>
                
                <div class="status warning">
                    ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="previousStep(3)" style="flex: 1;">
                        <span class="emoji">‚¨ÖÔ∏è</span>–ù–∞–∑–∞–¥
                    </button>
                    <button class="btn btn-success" onclick="registerParticipant()" id="registerBtn" style="flex: 2;">
                        <span class="emoji">üéâ</span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 4: –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
            <div class="step" id="step4">
                <div class="progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
                
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #28a745; margin-bottom: 15px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                    <p style="color: #666; margin-bottom: 15px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª—å!</p>
                    
                    <div class="status success">
                        <strong>‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</strong><br>
                        <span id="registrationTime"></span>
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #e3f7ff; border-radius: 12px;">
                        <strong>üéâ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ!</strong><br>
                        <span style="color: #666;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –∏ —Ö–æ—Ä–æ—à–µ–≥–æ –≤—Ä–µ–º—è–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è!</span>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="resetForm()">
                        üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
                    </button>
                </div>
            </div>

            <!-- –®–∞–≥ 5: –£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω -->
            <div class="step" id="step5">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #17a2b8; margin-bottom: 15px;">–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!</h2>
                    <p style="color: #666; margin-bottom: 20px;">–≠—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –ø—Ä–æ—à–µ–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª—å</p>
                    
                    <div class="status info" id="alreadyRegisteredInfo">
                        <strong>–î–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong><br>
                        <span id="existingRegistrationInfo"></span>
                    </div>
                    
                    <button class="btn btn-primary" onclick="resetForm()">
                        üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∏–∂–µ) -->
    <div class="admin-container" id="adminContainer">
        <div class="header" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); padding: 15px;">
            <h1 style="font-size: 1.4rem; margin-bottom: 5px;">üîß –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h1>
            <p style="font-size: 0.85rem;">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        </div>
        
        <div class="content">
            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É -->
            <div id="adminLoginSection" class="admin-login-section">
                <div style="font-size: 2rem; margin-bottom: 10px;">üîë</div>
                <h3 style="margin-bottom: 10px; color: #333;">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                <p style="color: #666; margin-bottom: 15px;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
                
                <div style="margin-bottom: 12px;">
                    <input type="password" id="adminPasswordInput" placeholder="–ü–∞—Ä–æ–ª—å" 
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                </div>
                
                <button class="btn btn-primary" onclick="loginAdmin()" style="margin-bottom: 8px; font-size: 0.9rem; padding: 12px;">
                    üîì –í–æ–π—Ç–∏
                </button>
                
                <div id="loginError" style="display: none; margin-top: 10px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 6px; font-size: 0.8rem;"></div>
            </div>
            
            <!-- –ì–ª–∞–≤–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
            <div id="adminPanel" style="display: none;">
                <div style="background: #e8f5e8; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>üîì –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω</strong>
                        <button onclick="logoutAdmin()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            üö™ –í—ã–π—Ç–∏
                        </button>
                    </div>
                    <div id="adminStats" style="font-size: 0.9rem; color: #155724;"></div>
                </div>
                
                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                <div class="admin-nav">
                    <button class="admin-nav-item active" onclick="showAdminTab('control')">üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                    <button class="admin-nav-item" onclick="showAdminTab('preview')">üëÅÔ∏è –ü—Ä–µ–≤—å—é</button>
                    <button class="admin-nav-item" onclick="showAdminTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>
                
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ -->
                <div class="admin-tab-content">
                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                    <div id="controlTab" class="admin-tab-pane active">
                        <h3 style="margin-bottom: 15px;">üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; margin-bottom: 8px; display: block;">üìÑ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel:</label>
                            <input type="file" id="dataFileInput" accept=".xlsx,.xls" style="font-size: 0.9rem; padding: 10px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="loadParticipantsData()" style="font-size: 0.9rem; padding: 12px;">
                                üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                            </button>
                            <button class="btn btn-success" onclick="exportRegistrations()" style="font-size: 0.9rem; padding: 12px;">
                                üìä –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                            </button>
                        </div>

                        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π -->
                        <div style="border: 2px solid #ffc107; background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</strong>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                        <span id="registrationStatusText">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞</span>
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="registrationToggle" checked onchange="toggleRegistration()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.8rem; color: #856404;">
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–º–æ–≥—É—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è<br>
                                <span id="firebaseStatus" style="font-size: 0.75rem; color: #666;"></span>
                            </div>
                        </div>
                        
                        <button class="btn btn-danger" onclick="clearAllRegistrations()" style="font-size: 0.9rem; padding: 12px;">
                            üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        </button>
                        
                        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏ -->
                        <div style="margin-top: 20px;">
                            <h4>üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
                            <div id="registrationsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px;"></div>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–µ–≤—å—é -->
                    <div id="previewTab" class="admin-tab-pane">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;" id="previewStats"></div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>üé≤ –®–∞–Ω—Å—ã</h3>
                            <div id="chancesPreview"></div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>üë• –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã</h3>
                            <div id="consultantsPreview"></div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>‚öñÔ∏è –í–µ—Å</h3>
                            <div id="weightPreview"></div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>üèÖ –ú–µ–¥–∞–ª–∏</h3>
                            <div id="medalsPreview"></div>
                        </div>
                    </div>
                    
                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div id="settingsTab" class="admin-tab-pane">
                        <h3 style="margin-bottom: 15px;">üîê –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; margin-bottom: 8px; display: block;">üîë –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                            <input type="password" id="newAdminPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <button class="btn btn-primary" onclick="changeAdminPassword()" style="font-size: 0.9rem; padding: 12px;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
                        </button>
                        
                        <div style="margin-top: 20px; padding: 10px; background: #e3f7ff; border-radius: 8px; font-size: 0.85rem; color: #0c5460;">
                            <strong>üí° –°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–∑ –±—É–∫–≤, —Ü–∏—Ñ—Ä –∏ —Å–∏–º–≤–æ–ª–æ–≤
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let participantsData = [];
        let consultantsData = {};
        let registrationsData = {};
        let currentStep = 'loadingStep';
        let selectedConsultant = null;
        let selectedParticipant = null;
        let isAdminAuthenticated = false;
        let registrationEnabled = true;
        let adminPassword = 'admin123';

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        window.initApp = async function() {
            console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                if (window.isFirebaseConnected) {
                    try {
                        await loadAdminSettings();
                    } catch (error) {
                        console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∞:", error);
                    }
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                const loadSuccess = await loadParticipantsFromSources();
                
                if (loadSuccess) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ Firebase
                    if (window.isFirebaseConnected) {
                        try {
                            await loadRegistrationsFromFirebase();
                        } catch (error) {
                            console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    if (!registrationEnabled) {
                        showStep('registrationClosedStep');
                    } else {
                        showStep('step1');
                    }
                    
                    setupEventListeners();
                    updateUI();
                    console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ");
                } else {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤");
                }
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
                document.getElementById('errorMessage').textContent = error.message;
                showStep('errorStep');
            }
        };

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –µ—Å–ª–∏ Firebase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
        setTimeout(() => {
            if (currentStep === 'loadingStep') {
                console.log("‚è∞ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...");
                window.initApp();
            }
        }, 3000);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        async function loadParticipantsFromSources() {
            // –£–±–∏—Ä–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ, —Ç—Ä–µ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞
            if (participantsData.length === 0) {
                console.log("üìã –î–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–∞.");
                showStep('errorStep');
                document.getElementById('errorMessage').innerHTML = `
                    <strong>–î–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</strong><br>
                    –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å Excel —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.<br><br>
                    <small>–í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–ø–∞—Ä–æ–ª—å: admin123) –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ä–∞–∑–¥–µ–ª–µ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"</small>
                `;
                return false;
            }
            
            return true;
        }

        // –£–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö
        async function loadDemoData() {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            return false;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Firebase
        async function loadRegistrationsFromFirebase() {
            if (!window.isFirebaseConnected) return;
            
            try {
                const registrationsRef = window.dbRef(window.db, 'registrations');
                
                return new Promise((resolve) => {
                    window.dbOnValue(registrationsRef, (snapshot) => {
                        const data = snapshot.val();
                        registrationsData = data || {};
                        console.log("üì• –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", Object.keys(registrationsData).length);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º UI –µ—Å–ª–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞
                        if (isAdminAuthenticated) {
                            updateAdminPreview();
                            updateAdminStats();
                            updateRegistrationsList();
                        }
                        
                        resolve();
                    });
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π:", error);
            }
        }

        async function saveRegistrationToFirebase(participantData) {
            if (!window.isFirebaseConnected) {
                console.warn("Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ");
                registrationsData[participantData.id] = participantData;
                return;
            }
            
            try {
                const registrationRef = window.dbRef(window.db, `registrations/${participantData.id}`);
                await window.dbSet(registrationRef, participantData);
                console.log("‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ Firebase");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
                throw error;
            }
        }

        async function loadAdminSettings() {
            if (!window.isFirebaseConnected) return;
            
            try {
                const settingsRef = window.dbRef(window.db, 'admin_settings');
                
                return new Promise((resolve) => {
                    window.dbOnValue(settingsRef, (snapshot) => {
                        const settings = snapshot.val();
                        if (settings) {
                            registrationEnabled = settings.registrationEnabled !== undefined ? settings.registrationEnabled : true;
                            adminPassword = settings.adminPassword || 'admin123';
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º UI
                            const toggle = document.getElementById('registrationToggle');
                            if (toggle) toggle.checked = registrationEnabled;
                            
                            updateRegistrationStatus();
                        }
                        resolve();
                    });
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:", error);
            }
        }

        async function saveAdminSettings() {
            if (!window.isFirebaseConnected) return;
            
            try {
                const settingsRef = window.dbRef(window.db, 'admin_settings');
                await window.dbSet(settingsRef, {
                    registrationEnabled: registrationEnabled,
                    adminPassword: adminPassword,
                    lastUpdated: new Date().toISOString()
                });
                console.log("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:", error);
            }
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
            currentStep = stepId;
        }

        function nextStep(step) {
            if (step === 1) {
                if (!selectedConsultant) {
                    showGlobalStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞', 'warning');
                    return;
                }
                loadParticipantsByConsultant(selectedConsultant);
                showStep('step2');
            } else if (step === 2) {
                if (!selectedParticipant) {
                    showGlobalStatus('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'warning');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫
                if (registrationsData[selectedParticipant.id]) {
                    showExistingRegistration(registrationsData[selectedParticipant.id]);
                    showStep('step5');
                    return;
                }
                
                updateConfirmationStep();
                showStep('step3');
            }
        }

        function previousStep(step) {
            if (step === 2) {
                showStep('step1');
            } else if (step === 3) {
                showStep('step2');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞
        function setupConsultantSelection() {
            const consultantCards = document.getElementById('consultantCards');
            const consultantSelect = document.getElementById('consultantSelect');
            const searchInput = document.getElementById('consultantSearch');
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            consultantCards.innerHTML = '';
            consultantSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞...</option>';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤
            Object.keys(consultantsData).forEach(consultant => {
                // –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (–∫–∞—Ä—Ç–æ—á–∫–∏)
                const card = document.createElement('div');
                card.className = 'consultant-card';
                card.textContent = consultant;
                card.onclick = () => selectConsultant(consultant, card);
                consultantCards.appendChild(card);
                
                // –ü–ö –≤–µ—Ä—Å–∏—è (select)
                const option = document.createElement('option');
                option.value = consultant;
                option.textContent = consultant;
                consultantSelect.appendChild(option);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.consultant-card').forEach(card => {
                    const consultantName = card.textContent.toLowerCase();
                    if (consultantName.includes(searchTerm)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ select –¥–ª—è –ü–ö
            consultantSelect.onchange = (e) => {
                if (e.target.value) {
                    selectConsultant(e.target.value);
                }
            };
        }

        function selectConsultant(consultant, cardElement = null) {
            selectedConsultant = consultant;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
            document.querySelectorAll('.consultant-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (cardElement) {
                cardElement.classList.add('selected');
            } else {
                // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–¥–µ–ª—è–µ–º –Ω—É–∂–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                document.querySelectorAll('.consultant-card').forEach(card => {
                    if (card.textContent === consultant) {
                        card.classList.add('selected');
                    }
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º select
            document.getElementById('consultantSelect').value = consultant;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ"
            document.getElementById('nextStep1').disabled = false;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        function loadParticipantsByConsultant(consultant) {
            const participants = consultantsData[consultant] || [];
            const participantCards = document.getElementById('participantCards');
            const participantSelect = document.getElementById('participantSelect');
            const searchInput = document.getElementById('participantSearch');
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            participantCards.innerHTML = '';
            participantSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞...</option>';
            selectedParticipant = null;
            document.getElementById('nextStep2').disabled = true;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            participants.forEach(participant => {
                // –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (–∫–∞—Ä—Ç–æ—á–∫–∏)
                const card = document.createElement('div');
                card.className = 'consultant-card';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫
                const isRegistered = registrationsData[participant.id];
                if (isRegistered) {
                    card.style.background = '#d4edda';
                    card.style.borderColor = '#c3e6cb';
                    card.innerHTML = `${participant.name}<br><small style="color: #155724;">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</small>`;
                } else {
                    card.textContent = participant.name;
                }
                
                card.onclick = () => selectParticipant(participant, card);
                participantCards.appendChild(card);
                
                // –ü–ö –≤–µ—Ä—Å–∏—è (select)
                const option = document.createElement('option');
                option.value = participant.id;
                option.textContent = isRegistered ? `${participant.name} (‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)` : participant.name;
                participantSelect.appendChild(option);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#participantCards .consultant-card').forEach(card => {
                    const participantName = card.textContent.toLowerCase();
                    if (participantName.includes(searchTerm)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ select –¥–ª—è –ü–ö
            participantSelect.onchange = (e) => {
                if (e.target.value) {
                    const participant = participants.find(p => p.id == e.target.value);
                    selectParticipant(participant);
                }
            };
        }

        function selectParticipant(participant, cardElement = null) {
            selectedParticipant = participant;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
            document.querySelectorAll('#participantCards .consultant-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (cardElement) {
                cardElement.classList.add('selected');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º select
            document.getElementById('participantSelect').value = participant.id;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ"
            document.getElementById('nextStep2').disabled = false;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function updateConfirmationStep() {
            document.getElementById('confirmName').textContent = selectedParticipant.name;
            document.getElementById('confirmConsultant').textContent = selectedConsultant;
        }

        async function registerParticipant() {
            try {
                document.getElementById('registerBtn').disabled = true;
                
                const registrationData = {
                    id: selectedParticipant.id,
                    name: selectedParticipant.name,
                    consultant: selectedConsultant,
                    chances: selectedParticipant.chances,
                    weight: selectedParticipant.weight || 0,
                    medal: selectedParticipant.medal || '–£—á–∞—Å—Ç–Ω–∏–∫',
                    registrationTime: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                await saveRegistrationToFirebase(registrationData);
                registrationsData[selectedParticipant.id] = registrationData;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                const registrationTime = new Date().toLocaleString('ru-RU');
                document.getElementById('registrationTime').textContent = `–í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${registrationTime}`;
                
                showStep('step4');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
                if (isAdminAuthenticated) {
                    updateAdminPreview();
                    updateAdminStats();
                    updateRegistrationsList();
                }
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
                showGlobalStatus('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
                document.getElementById('registerBtn').disabled = false;
            }
        }

        function showExistingRegistration(registration) {
            const registrationTime = new Date(registration.registrationTime).toLocaleString('ru-RU');
            document.getElementById('existingRegistrationInfo').innerHTML = `
                <strong>–ò–º—è:</strong> ${registration.name}<br>
                <strong>–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç:</strong> ${registration.consultant}<br>
                <strong>–í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${registrationTime}
            `;
        }

        function resetForm() {
            selectedConsultant = null;
            selectedParticipant = null;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã
            document.getElementById('consultantSearch').value = '';
            document.getElementById('participantSearch').value = '';
            document.querySelectorAll('.consultant-card').forEach(card => {
                card.classList.remove('selected', 'hidden');
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('nextStep1').disabled = true;
            document.getElementById('nextStep2').disabled = true;
            document.getElementById('registerBtn').disabled = false;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø–µ—Ä–≤–æ–º—É —à–∞–≥—É
            showStep('step1');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function loginAdmin() {
            const inputPassword = document.getElementById('adminPasswordInput').value;
            
            if (inputPassword === adminPassword) {
                isAdminAuthenticated = true;
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                updateAdminStats();
                updateAdminPreview();
                updateRegistrationsList();
                showGlobalStatus('–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                errorDiv.style.display = 'block';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
            
            document.getElementById('adminPasswordInput').value = '';
        }

        function logoutAdmin() {
            isAdminAuthenticated = false;
            document.getElementById('adminLoginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            showGlobalStatus('–í—ã—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info');
        }

        function showAdminTab(tabName) {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.querySelectorAll('.admin-tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –ø—Ä–µ–≤—å—é
            if (tabName === 'preview') {
                updateAdminPreview();
            }
        }

        async function toggleRegistration() {
            registrationEnabled = document.getElementById('registrationToggle').checked;
            updateRegistrationStatus();
            
            try {
                await saveAdminSettings();
                showGlobalStatus(
                    registrationEnabled ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞', 
                    registrationEnabled ? 'success' : 'warning'
                );
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:", error);
                showGlobalStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }

        function updateRegistrationStatus() {
            const statusText = document.getElementById('registrationStatusText');
            if (statusText) {
                statusText.textContent = registrationEnabled ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞';
                statusText.style.color = registrationEnabled ? '#28a745' : '#dc3545';
            }
        }

        async function clearAllRegistrations() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                return;
            }
            
            try {
                if (window.isFirebaseConnected) {
                    const registrationsRef = window.dbRef(window.db, 'registrations');
                    await window.dbRemove(registrationsRef);
                }
                
                registrationsData = {};
                updateAdminPreview();
                updateAdminStats();
                updateRegistrationsList();
                showGlobalStatus('–í—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã', 'success');
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π:", error);
                showGlobalStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π', 'error');
            }
        }

        async function removeRegistration(participantId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é?')) {
                return;
            }
            
            try {
                if (window.isFirebaseConnected) {
                    const registrationRef = window.dbRef(window.db, `registrations/${participantId}`);
                    await window.dbRemove(registrationRef);
                }
                
                delete registrationsData[participantId];
                updateAdminPreview();
                updateAdminStats();
                updateRegistrationsList();
                showGlobalStatus('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
                showGlobalStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
            }
        }

        async function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            
            if (!newPassword) {
                showGlobalStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å', 'warning');
                return;
            }
            
            if (newPassword.length < 4) {
                showGlobalStatus('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'warning');
                return;
            }
            
            try {
                adminPassword = newPassword;
                await saveAdminSettings();
                
                document.getElementById('newAdminPassword').value = '';
                showGlobalStatus('–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω', 'success');
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è:", error);
                showGlobalStatus('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è: ' + error.message, 'error');
            }
        }

        function updateAdminStats() {
            const totalParticipants = participantsData.length;
            const registeredCount = Object.keys(registrationsData).length;
            const totalChances = participantsData.reduce((sum, p) => sum + p.chances, 0);
            const registeredChances = Object.values(registrationsData).reduce((sum, r) => sum + r.chances, 0);
            
            const statsElement = document.getElementById('adminStats');
            if (statsElement) {
                statsElement.innerHTML = `
                    <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong><br>
                    üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${registeredCount} –∏–∑ ${totalParticipants} 
                    (${totalParticipants > 0 ? Math.round(registeredCount / totalParticipants * 100) : 0}%)<br>
                    üé≤ –®–∞–Ω—Å—ã: ${registeredChances} –∏–∑ ${totalChances}<br>
                    üìà –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤: ${Object.keys(consultantsData).length}<br>
                    üî• –°—Ç–∞—Ç—É—Å Firebase: ${window.isFirebaseConnected ? '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω'}
                `;
            }
        }

        function updateRegistrationsList() {
            const listElement = document.getElementById('registrationsList');
            if (!listElement) return;
            
            const registrations = Object.values(registrationsData)
                .sort((a, b) => new Date(b.registrationTime) - new Date(a.registrationTime));
            
            if (registrations.length === 0) {
                listElement.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
                return;
            }
            
            let html = '';
            registrations.forEach(reg => {
                const registrationTime = new Date(reg.registrationTime).toLocaleString('ru-RU');
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #f9f9f9; margin-bottom: 5px; border-radius: 5px;">
                        <div>
                            <div style="font-weight: bold;">${reg.name}</div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${reg.consultant} ‚Ä¢ ${registrationTime} ‚Ä¢ 
                                ${reg.chances} —à–∞–Ω—Å(–æ–≤) ‚Ä¢ ${reg.weight || 0} –∫–≥ ‚Ä¢ ${reg.medal || '–£—á–∞—Å—Ç–Ω–∏–∫'}
                            </div>
                        </div>
                        <button onclick="removeRegistration(${reg.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }

        function updateAdminPreview() {
            updatePreviewStats();
            updateChancesPreview();
            updateConsultantsPreview();
            updateWeightPreview();
            updateMedalsPreview();
        }

        function updatePreviewStats() {
            const registeredCount = Object.keys(registrationsData).length;
            const totalChances = Object.values(registrationsData).reduce((sum, r) => sum + r.chances, 0);
            const totalWeight = Object.values(registrationsData).reduce((sum, r) => sum + (r.weight || 0), 0);
            
            document.getElementById('previewStats').innerHTML = `
                <div style="text-align: center; padding: 10px; background: #e3f7ff; border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #4facfe;">${registeredCount}</div>
                    <div style="font-size: 0.8rem; color: #666;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">${totalChances}</div>
                    <div style="font-size: 0.8rem; color: #666;">–ß–µ—Å—Ç–Ω—ã—Ö —à–∞–Ω—Å–æ–≤</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #fff3cd; border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #856404;">${totalWeight}</div>
                    <div style="font-size: 0.8rem; color: #666;">–ö–≥ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>
                </div>
            `;
        }

        function updateChancesPreview() {
            const chancesPreview = document.getElementById('chancesPreview');
            if (!chancesPreview) return;
            
            const lotteryEntries = [];
            Object.values(registrationsData).forEach(reg => {
                for (let i = 0; i < reg.chances; i++) {
                    lotteryEntries.push(reg.name);
                }
            });
            
            let html = '';
            
            if (lotteryEntries.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
            } else {
                html += '<div style="margin-bottom: 15px; text-align: center;">';
                html += '<button class="randomize-btn" onclick="randomizeChancesList()">üé≤ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                const displayList = window.randomizedChancesList || lotteryEntries;
                const hasDataToCopy = displayList.length > 0;
                
                html += `<button class="copy-btn" onclick="copyChancesToClipboard()" ${hasDataToCopy ? '' : 'disabled'}>üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>`;
                html += '</div>';
                
                html += '<h3>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ—Ç–µ—Ä–µ–∏:</h3>';
                
                html += '<div class="chances-list">';
                displayList.forEach((name) => {
                    html += `<div class="chance-item">${name}</div>`;
                });
                html += '</div>';
                
                html += `<div style="margin-top: 15px; padding: 10px; background: #e3f7ff; border-radius: 5px; color: #0c5460; font-size: 0.9rem;">
                    üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ—Ç–µ—Ä–µ–µ: ${displayList.length}<br>
                    ${window.randomizedChancesList ? 'üé≤ –°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ—à–∞–Ω' : 'üìã –ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫'}
                </div>`;
            }
            
            chancesPreview.innerHTML = html;
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏
        function randomizeChancesList() {
            const lotteryEntries = [];
            Object.values(registrationsData).forEach(reg => {
                for (let i = 0; i < reg.chances; i++) {
                    lotteryEntries.push(reg.name);
                }
            });
            
            if (lotteryEntries.length > 0) {
                // –°–æ–∑–¥–∞–µ–º —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ
                window.randomizedChancesList = shuffleArray(lotteryEntries);
                updateChancesPreview();
                showGlobalStatus('–°–ø–∏—Å–æ–∫ –ª–æ—Ç–µ—Ä–µ–∏ –ø–µ—Ä–µ–º–µ—à–∞–Ω! üé≤', 'success');
                console.log('–°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ—à–∞–Ω, –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫:', window.randomizedChancesList.slice(0, 10));
            } else {
                showGlobalStatus('–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è', 'warning');
            }
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ —à–∞–Ω—Å–æ–≤ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyChancesToClipboard() {
            try {
                const lotteryEntries = [];
                Object.values(registrationsData).forEach(reg => {
                    for (let i = 0; i < reg.chances; i++) {
                        lotteryEntries.push(reg.name);
                    }
                });
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏—Å—Ö–æ–¥–Ω—ã–π
                const displayList = window.randomizedChancesList || lotteryEntries;
                
                if (displayList.length === 0) {
                    showGlobalStatus('–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–∞–∂–¥–æ–µ –∏–º—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ)
                const textToCopy = displayList.join('\n');
                
                // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                if (navigator.clipboard && window.isSecureContext) {
                    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è HTTPS
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        const listType = window.randomizedChancesList ? '–ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π' : '–∏—Å—Ö–æ–¥–Ω—ã–π';
                        showGlobalStatus(`üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ${displayList.length} –∑–∞–ø–∏—Å–µ–π (${listType} —Å–ø–∏—Å–æ–∫)`, 'success');
                        console.log('–°–ø–∏—Å–æ–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä:', displayList.slice(0, 5), '...');
                    }).catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                        showFallbackCopyModal(textToCopy);
                    });
                } else {
                    // Fallback –¥–ª—è HTTP –∏–ª–∏ —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        textArea.remove();
                        const listType = window.randomizedChancesList ? '–ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π' : '–∏—Å—Ö–æ–¥–Ω—ã–π';
                        showGlobalStatus(`üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ${displayList.length} –∑–∞–ø–∏—Å–µ–π (${listType} —Å–ø–∏—Å–æ–∫)`, 'success');
                        console.log('–°–ø–∏—Å–æ–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä:', displayList.slice(0, 5), '...');
                    } catch (err) {
                        textArea.remove();
                        showFallbackCopyModal(textToCopy);
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                showGlobalStatus('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'error');
            }
        }

        function showFallbackCopyModal(textToCopy) {
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 9999; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto;">
                    <h3>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:</h3>
                    <textarea readonly style="width: 100%; height: 300px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${textToCopy}</textarea>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ textarea
            setTimeout(() => {
                const textarea = modal.querySelector('textarea');
                textarea.focus();
                textarea.select();
            }, 100);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞
        function shuffleArray(array) {
            const shuffled = array.slice();
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            return shuffled;
        }

        function updateConsultantsPreview() {
            let html = '<h3>–ö–ª–∏–µ–Ω—Ç—ã –ø–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞–º (–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ):</h3>';
            
            const consultantsByClients = Object.keys(consultantsData).map(consultant => {
                const participants = consultantsData[consultant];
                const registered = participants.filter(p => registrationsData[p.id]);
                return { consultant, participants, registered };
            }).sort((a, b) => b.registered.length - a.registered.length);
            
            if (consultantsByClients.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤</div>';
            } else {
                consultantsByClients.forEach((data, index) => {
                    const consultantId = `consultant-${index}`;
                    html += `
                        <div style="margin-bottom: 15px;">
                            <div class="consultant-header" onclick="toggleConsultantClients('${consultantId}')" style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #ddd;">
                                <span><strong>${data.consultant}</strong> - ${data.registered.length} –∏–∑ ${data.participants.length} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</span>
                                <span id="icon-${consultantId}" style="float: right;">‚ñ∂</span>
                            </div>
                            <div class="consultant-content" id="${consultantId}" style="display: none; padding: 10px; border: 1px solid #ddd; border-top: none;">
                    `;
                    
                    data.participants.forEach(participant => {
                        const isRegistered = registrationsData[participant.id];
                        html += `
                            <div style="padding: 3px 0; ${isRegistered ? 'color: #28a745; font-weight: 600;' : 'color: #dc3545;'}">
                                ${isRegistered ? '‚úÖ' : '‚ùå'} ${participant.name}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('consultantsPreview').innerHTML = html;
        }

        function toggleConsultantClients(consultantId) {
            const content = document.getElementById(consultantId);
            const icon = document.getElementById(`icon-${consultantId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function updateWeightPreview() {
            let html = '<h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–µ—Å—É:</h3>';
            
            const registeredParticipants = Object.values(registrationsData);
            if (registeredParticipants.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
            } else {
                const totalWeight = registeredParticipants.reduce((sum, p) => sum + (p.weight || 0), 0);
                const avgWeight = Math.round(totalWeight / registeredParticipants.length);
                
                html += `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <strong>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–µ—Å—É:</strong><br>
                            –û–±—â–∏–π –≤–µ—Å: ${totalWeight} –∫–≥<br>
                            –°—Ä–µ–¥–Ω–∏–π –≤–µ—Å: ${avgWeight} –∫–≥<br>
                            –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${registeredParticipants.length}
                        </div>
                    </div>
                `;
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Å—É
                const sortedByWeight = registeredParticipants
                    .sort((a, b) => (b.weight || 0) - (a.weight || 0));
                
                html += '<div style="max-height: 300px; overflow-y: auto;">';
                sortedByWeight.forEach(participant => {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                            <span>${participant.name}</span>
                            <span style="font-weight: bold;">${participant.weight || 0} –∫–≥</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('weightPreview').innerHTML = html;
        }

        function updateMedalsPreview() {
            let html = '<h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ–¥–∞–ª–µ–π:</h3>';
            
            const registeredParticipants = Object.values(registrationsData);
            if (registeredParticipants.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
            } else {
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ–¥–∞–ª—è–º
                const medalGroups = {};
                registeredParticipants.forEach(participant => {
                    const medal = participant.medal || '–£—á–∞—Å—Ç–Ω–∏–∫';
                    if (!medalGroups[medal]) {
                        medalGroups[medal] = [];
                    }
                    medalGroups[medal].push(participant);
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –º–µ–¥–∞–ª–µ–π
                const medalOrder = ['–ó–æ–ª–æ—Ç–æ', '–°–µ—Ä–µ–±—Ä–æ', '–ë—Ä–æ–Ω–∑–∞', '–£—á–∞—Å—Ç–Ω–∏–∫'];
                const sortedMedals = Object.keys(medalGroups).sort((a, b) => {
                    const aIndex = medalOrder.indexOf(a);
                    const bIndex = medalOrder.indexOf(b);
                    if (aIndex === -1) return 1;
                    if (bIndex === -1) return -1;
                    return aIndex - bIndex;
                });
                
                sortedMedals.forEach(medal => {
                    const participants = medalGroups[medal];
                    const medalIcon = {
                        '–ó–æ–ª–æ—Ç–æ': 'ü•á',
                        '–°–µ—Ä–µ–±—Ä–æ': 'ü•à',
                        '–ë—Ä–æ–Ω–∑–∞': 'ü•â',
                        '–£—á–∞—Å—Ç–Ω–∏–∫': 'üèÖ'
                    }[medal] || 'üèÖ';
                    
                    html += `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                ${medalIcon} ${medal} (${participants.length})
                            </div>
                            <div style="padding: 10px; border: 1px solid #ddd; border-top: none;">
                    `;
                    
                    participants.forEach(participant => {
                        html += `
                            <div style="padding: 2px 0;">
                                ‚Ä¢ ${participant.name}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('medalsPreview').innerHTML = html;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞
        async function loadParticipantsData() {
            const fileInput = document.getElementById('dataFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showGlobalStatus('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'warning');
                return;
            }
            
            try {
                showGlobalStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                const data = await readExcelFile(file);
                processParticipantsData(data);
                
                showGlobalStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                setupEventListeners();
                updateUI();
                
                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                if (registrationEnabled) {
                    showStep('step1');
                } else {
                    showStep('registrationClosedStep');
                }
                
                if (isAdminAuthenticated) {
                    updateAdminStats();
                    updateAdminPreview();
                }
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", error);
                showGlobalStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
                reader.readAsArrayBuffer(file);
            });
        }

        function processParticipantsData(data) {
            participantsData = data.map((row, index) => ({
                id: index + 1,
                name: row['–ò–º—è'] || row['Name'] || row['–§–ò–û'] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫',
                consultant: row['–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç'] || row['Consultant'] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç',
                chances: parseInt(row['–®–∞–Ω—Å—ã'] || row['Chances'] || 1),
                weight: parseFloat(row['–í–µ—Å'] || row['Weight'] || 0),
                medal: row['–ú–µ–¥–∞–ª—å'] || row['Medal'] || '–£—á–∞—Å—Ç–Ω–∏–∫'
            }));
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞–º
            consultantsData = {};
            participantsData.forEach(participant => {
                if (!consultantsData[participant.consultant]) {
                    consultantsData[participant.consultant] = [];
                }
                consultantsData[participant.consultant].push(participant);
            });
            
            console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:", participantsData.length);
            console.log("–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤:", Object.keys(consultantsData).length);
        }

        function exportRegistrations() {
            if (Object.keys(registrationsData).length === 0) {
                showGlobalStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            
            try {
                const registrations = Object.values(registrationsData);
                const exportData = registrations.map(reg => ({
                    'ID': reg.id,
                    '–ò–º—è': reg.name,
                    '–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç': reg.consultant,
                    '–®–∞–Ω—Å—ã': reg.chances,
                    '–í–µ—Å': reg.weight || 0,
                    '–ú–µ–¥–∞–ª—å': reg.medal || '–£—á–∞—Å—Ç–Ω–∏–∫',
                    '–í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏': new Date(reg.registrationTime).toLocaleString('ru-RU')
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                
                const fileName = `registrations_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showGlobalStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª ' + fileName, 'success');
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:", error);
                showGlobalStatus('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ UI
        function setupEventListeners() {
            setupConsultantSelection();
            
            // Enter –¥–ª—è –∞–¥–º–∏–Ω –ø–∞—Ä–æ–ª—è
            const adminPasswordInput = document.getElementById('adminPasswordInput');
            if (adminPasswordInput) {
                adminPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginAdmin();
                    }
                });
            }
        }

        function updateUI() {
            setupConsultantSelection();
            updateRegistrationStatus();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å Firebase
            const firebaseStatus = document.getElementById('firebaseStatus');
            if (firebaseStatus) {
                firebaseStatus.textContent = window.isFirebaseConnected ? 
                    '‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω' : 
                    '‚ö†Ô∏è Firebase –æ—Ç–∫–ª—é—á–µ–Ω (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)';
            }
        }

        function showGlobalStatus(message, type = 'info') {
            const statusElement = document.getElementById('globalStatus');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        setInterval(async () => {
            if (window.isFirebaseConnected && window.db) {
                try {
                    await loadRegistrationsFromFirebase();
                    await loadAdminSettings();
                    
                    // –ï—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ –∞–¥–º–∏–Ω–æ–º, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–∫—Ä–∞–Ω
                    if (!registrationEnabled && !document.getElementById('registrationClosedStep').classList.contains('active') && !isAdminAuthenticated) {
                        showStep('registrationClosedStep');
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);
                }
            }
        }, 10000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è HTML onclick
        window.randomizeChancesList = randomizeChancesList;
        window.copyChancesToClipboard = copyChancesToClipboard;
        window.removeRegistration = removeRegistration;
        window.toggleConsultantClients = toggleConsultantClients;
    </script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
